version: '3.8'

services:
  fourier-cycles-api:
    build:
      context: .
      dockerfile: api/Dockerfile
    container_name: fourier-cycles-api
    restart: unless-stopped
    environment:
      TZ: ${TZ:-Europe/Vienna}
      FOURIER_OUTPUT_DIR: ${FOURIER_OUTPUT_DIR:-/data/output}
      FOURIER_TIMEFRAME_DAYS: ${FOURIER_TIMEFRAME_DAYS:-1095}
      FOURIER_RESAMPLE_RULE: ${FOURIER_RESAMPLE_RULE:-1D}
      FOURIER_YAHOO_SYMBOLS: ${FOURIER_YAHOO_SYMBOLS:-SPY,BTC-USD}
      FOURIER_FRED_SERIES: ${FOURIER_FRED_SERIES:-DGS10,CPIAUCSL}
      FOURIER_TOP_K: ${FOURIER_TOP_K:-8}
      FOURIER_MIN_PRESENCE_RATIO: ${FOURIER_MIN_PRESENCE_RATIO:-0.30}
      FOURIER_MIN_WINDOW_POWER_RATIO: ${FOURIER_MIN_WINDOW_POWER_RATIO:-0.03}
      FOURIER_ROLLING_WINDOW_RATIO: ${FOURIER_ROLLING_WINDOW_RATIO:-0.35}
      FOURIER_ROLLING_STEP_RATIO: ${FOURIER_ROLLING_STEP_RATIO:-0.25}
      FOURIER_MIN_PERIOD_DAYS: ${FOURIER_MIN_PERIOD_DAYS:-30}
      FOURIER_MAX_PERIOD_DAYS: ${FOURIER_MAX_PERIOD_DAYS:-300}
      FOURIER_SELECTION_TOP_K: ${FOURIER_SELECTION_TOP_K:-3}
      FOURIER_SELECTION_MIN_PRESENCE_RATIO: ${FOURIER_SELECTION_MIN_PRESENCE_RATIO:-0.50}
      FOURIER_SELECTION_MIN_NORM_POWER_PERCENTILE: ${FOURIER_SELECTION_MIN_NORM_POWER_PERCENTILE:-0.75}
      FOURIER_SELECTION_MIN_PERIOD_DISTANCE_RATIO: ${FOURIER_SELECTION_MIN_PERIOD_DISTANCE_RATIO:-0.20}
      FOURIER_SELECTION_MIN_PHASE_LOCKING_R: ${FOURIER_SELECTION_MIN_PHASE_LOCKING_R:-0.04}
      FOURIER_SELECTION_MIN_AMP_SIGMA: ${FOURIER_SELECTION_MIN_AMP_SIGMA:-0.06}
      FOURIER_MIN_POINTS: ${FOURIER_MIN_POINTS:-180}
      FOURIER_TIMEOUT_SECONDS: ${FOURIER_TIMEOUT_SECONDS:-30}
      FOURIER_TRIGGER_MAX_RUNTIME_SECONDS: ${FOURIER_TRIGGER_MAX_RUNTIME_SECONDS:-5400}
    volumes:
      - ${FOURIER_OUTPUT_DIR_HOST:-./output}:/data/output
    networks:
      - ai-stack-fourier
    healthcheck:
      test: [ "CMD", "python", "-c", "import urllib.request,sys; sys.exit(0 if urllib.request.urlopen('http://127.0.0.1:8080/healthz', timeout=3).status == 200 else 1)" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  fourier-cycles-ui:
    build:
      context: ./ui
      dockerfile: Dockerfile
    container_name: fourier-cycles-ui
    restart: unless-stopped
    depends_on:
      - fourier-cycles-api
    ports:
      - "${FOURIER_UI_HOST_PORT:-3010}:80"
    volumes:
      - ${FOURIER_OUTPUT_DIR_HOST:-./output}:/data:ro
    networks:
      - ai-stack-fourier
    healthcheck:
      test: [ "CMD", "wget", "-qO-", "http://127.0.0.1:80/healthz" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

networks:
  ai-stack-fourier:
    name: ai-stack-fourier
    driver: bridge
