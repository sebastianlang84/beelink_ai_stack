name: tm
services:
  tm:
    container_name: tm
    image: tm:latest
    build:
      context: .
    restart: unless-stopped
    environment:
      TRANSCRIPT_MINER_DEFAULT_LANGUAGES: ${TRANSCRIPT_MINER_DEFAULT_LANGUAGES:-de,en}
      TRANSCRIPT_MINER_LOG_LEVEL: ${TRANSCRIPT_MINER_LOG_LEVEL:-info}
      TRANSCRIPT_MINER_CONFIG_DIR: /transcript_miner_config
      TRANSCRIPT_MINER_OUTPUT_DIR: /transcript_miner_output
      YOUTUBE_API_KEY: ${YOUTUBE_API_KEY:-}
      YOUTUBE_COOKIES_FILE: ${YOUTUBE_COOKIES_FILE:-}
      YOUTUBE_PROXY_MODE: ${YOUTUBE_PROXY_MODE:-}
      YOUTUBE_PROXY_HTTP_URL: ${YOUTUBE_PROXY_HTTP_URL:-}
      YOUTUBE_PROXY_HTTPS_URL: ${YOUTUBE_PROXY_HTTPS_URL:-}
      YOUTUBE_PROXY_FILTER_IP_LOCATIONS: ${YOUTUBE_PROXY_FILTER_IP_LOCATIONS:-}
      WEBSHARE_USERNAME: ${WEBSHARE_USERNAME:-}
      WEBSHARE_PASSWORD: ${WEBSHARE_PASSWORD:-}
      OPENROUTER_API_KEY: ${OPENROUTER_API_KEY:-}
      OPEN_WEBUI_KNOWLEDGE_ID_BY_TOPIC_JSON: ${OPEN_WEBUI_KNOWLEDGE_ID_BY_TOPIC_JSON:-}
      OPEN_WEBUI_KNOWLEDGE_ID_BY_TOPIC_JSON_PATH: ${OPEN_WEBUI_KNOWLEDGE_ID_BY_TOPIC_JSON_PATH:-}
      OPEN_WEBUI_KNOWLEDGE_ID: ${OPEN_WEBUI_KNOWLEDGE_ID:-}
      OPEN_WEBUI_BASE_URL: ${OPEN_WEBUI_BASE_URL:-http://owui:8080}
      OPEN_WEBUI_API_KEY: ${OPEN_WEBUI_API_KEY:-}
      OWUI_API_KEY: ${OWUI_API_KEY:-}
      OPEN_WEBUI_AUTO_SYNC_AFTER_RUN: ${OPEN_WEBUI_AUTO_SYNC_AFTER_RUN:-}
      OPEN_WEBUI_CREATE_KNOWLEDGE_IF_MISSING: ${OPEN_WEBUI_CREATE_KNOWLEDGE_IF_MISSING:-}
      OPEN_WEBUI_SYNC_ON_SUMMARY: ${OPEN_WEBUI_SYNC_ON_SUMMARY:-}
      OPEN_WEBUI_SYNC_BASE_URL: ${OPEN_WEBUI_SYNC_BASE_URL:-}
      OPEN_WEBUI_PROCESS_POLL_INTERVAL_SECONDS: ${OPEN_WEBUI_PROCESS_POLL_INTERVAL_SECONDS:-3}
      OPEN_WEBUI_PROCESS_TIMEOUT_SECONDS: ${OPEN_WEBUI_PROCESS_TIMEOUT_SECONDS:-900}
      OPEN_WEBUI_INDEX_MAX_ATTEMPTS: ${OPEN_WEBUI_INDEX_MAX_ATTEMPTS:-3}
      OPEN_WEBUI_INDEX_RETRY_BACKOFF_SECONDS: ${OPEN_WEBUI_INDEX_RETRY_BACKOFF_SECONDS:-5}
      INDEXER_DB_PATH: /data/indexer.sqlite3
      HTTP_PROXY: ${HTTP_PROXY:-}
      HTTPS_PROXY: ${HTTPS_PROXY:-}
      NO_PROXY: ${NO_PROXY:-}
      PYTHONPATH: /transcript_miner_repo/src
    volumes:
      - ../transcript-miner/config:/transcript_miner_config
      - ../config:/config:ro
      # Host output root (bind-mount). Default: /home/wasti/ai_stack_data/transcript-miner/output
      - ${TRANSCRIPT_MINER_OUTPUT_ROOT_HOST:-/home/wasti/ai_stack_data/transcript-miner/output}:/transcript_miner_output
      # Host data root (bind-mount) to keep config absolute paths valid inside the container.
      - ${AI_STACK_DATA_DIR_HOST:-/home/wasti/ai_stack_data}:/home/wasti/ai_stack_data
      - ../transcript-miner:/transcript_miner_repo:ro
      # Host secrets artefacts dir (e.g. youtube_cookies.txt). Default mounts repo root.
      - ${AI_STACK_SECRETS_DIR_HOST:-..}:/host_secrets:ro
      - tm-data:/data
    networks:
      - ai-stack
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request; urllib.request.urlopen('http://127.0.0.1:8000/healthz').read(); print('ok')\""]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 10s

networks:
  ai-stack:
    external: true
    name: ai-stack

volumes:
  tm-data:
    external: true
    name: tm-data
